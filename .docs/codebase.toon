# PacketBuddy Codebase - TOON Format

[meta]
project = "PacketBuddy"
version = "1.4.3"
updated = "2026-02-20"
type = "network_monitoring_tool"
platforms = ["Windows", "macOS", "Linux"]

[summary]
desc = "Ultra-lightweight network usage tracker. <40MB RAM, <0.3% CPU."
tech_stack = ["Python 3.11+", "FastAPI", "SQLite", "NeonDB (Optional Sync)", "psutil", "Chart.js"]
v1_4_2_update = "Crash recovery with hourly watchdog, catch-up usage logic, primary interface detection, auto service registration on updates, Unicode fixes"
v1_4_3_update = "NeonDB storage optimization with separate retention policies, VACUUM ANALYZE, crisis mode cleanup, storage monitoring API"

[storage_architecture]
local = "SQLite: 30 days synced logs, 12 months aggregates (long-term history)"
neon = "NeonDB: 7 days logs, 3 months aggregates (free tier optimized)"
cleanup = "Automatic periodic cleanup + manual triggers"
vacuum = "VACUUM ANALYZE reclaims space after deletions"
methods = {get_storage_usage="Returns MB per table", get_storage_usage_percent="% of 512MB limit", aggressive_cleanup="Emergency cleanup for storage crisis", vacuum_database="Reclaims disk space"}

[structure]
root = "packet-buddy/"
main_dirs = ["src/", "dashboard/", "service/", "scripts/", "docs/", ".docs/"]

[structure.src]
api = {server="FastAPI server.py", routes="routes.py endpoints", version="version.py dynamic read"}
core = {monitor="Network polling (psutil), primary interface detection, catch-up logic", storage="SQLite + Peak Speed + system_state + cleanup/vacuum methods", sync="NeonDB sync + storage optimization + VACUUM + aggressive cleanup", device="Unique ID generation"}
cli = {main="CLI interface (pb today, pb export, etc)"}
utils = {config="TOML loader", formatters="Unit conversion", updater="Auto-check & Apply + PATH/service update"}

[structure.service]
windows = ["setup.bat", "run-service.bat", "launcher.py (headless runner)", "watchdog.bat (crash recovery)"]
unix = ["setup.sh", "systemd/LaunchAgent templates"]

[data_flow]
capture = "psutil.net_io_counters() per interface -> Primary interface detection (gateway-based)"
validation = "Max 1GB/s filter -> Battery-aware polling (2s on batt, 1s on AC)"
catch_up = "Boot time detection -> Absolute counter tracking -> Records usage while app was closed"
storage = "Batch write to SQLite every 30s -> Peak speed persistent update -> system_state for restart"
sync = "Background task uploads to NeonDB (PostgreSQL) every 60s"
cleanup = "Periodic (24h): Delete old synced logs -> Delete old aggregates -> VACUUM -> Check storage warning"
api = "FastAPI serves JSON/HTML/TOON exports on port 7373"

[v1_4_0_exports]
csv = "Spreadsheet friendly daily stats"
json = "Programmatic comprehensive metrics"
html = "Spotify-style 'Year Wrap-Up' beautiful report"
toon = "Token Optimized Object Notation (~60% smaller than markdown)"

[peak_speed_logic]
method = "Storage.update_peak_speed(new_speed)"
persistence = "Saved to 'daily_aggregates' table in SQLite"
backfill = "Service identifies missing peak speed rows and backfills from usage logs"

[crash_recovery]
watchdog = "Hourly repetition trigger in Task Scheduler ensures service restarts if crashed"
boot_detection = "Tracks boot_time in system_state to detect system restarts"
catch_up = "Compares current absolute counters with saved counters to record usage while app was closed"
auto_service_reg = "During update, service is re-registered to ensure persistence"

[decision_tree_for_agents]
question = "index.toon -> quick-reference.toon"
bug_fix = "codebase.toon -> [structure.src] -> [dev_workflow]"
feature = "architecture.toon [design_principles] -> codebase.toon [dev_workflow]"
deployment = "architecture.toon [deployment_checks]"

[dev_workflow]
setup = "python -m venv venv && pip install -r requirements.txt"
run = "python -m src.api.server"
test_api = "curl http://127.0.0.1:7373/api/health"
logs = "%USERPROFILE%\\.packetbuddy\\stderr.log"

[for_llms]
read_first = ".docs/index.toon"
troubleshooting = ".docs/quick-reference.toon"
deep_dive = [".docs/codebase.toon", ".docs/architecture.toon"]
token_tip = "Use .toon files for architecture/codebase context to save thousands of tokens"
