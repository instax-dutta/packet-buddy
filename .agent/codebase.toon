# PacketBuddy Codebase - TOON Format
# Token Optimized Object Notation for LLM consumption

[meta]
project = "PacketBuddy"
version = "1.3.0"
updated = "2026-01-08"
type = "network_monitoring_tool"
platforms = ["Windows", "macOS", "Linux"]

[summary]
desc = "Ultra-lightweight network usage tracker. <40MB RAM, <0.5% CPU. Runs as background service, provides web dashboard."
tech_stack = ["Python 3.11+", "FastAPI", "SQLite", "psutil", "Chart.js"]
key_features = ["Real-time monitoring", "Auto-updates", "Cloud sync (optional)", "Web dashboard", "CLI interface"]

[structure]
root = "packet-buddy/"
main_dirs = ["src/", "dashboard/", "service/", "docs/", ".agent/"]

[structure.src]
api = {server="FastAPI app", routes="API endpoints"}
core = {monitor="Network polling (psutil)", storage="SQLite ops", sync="NeonDB sync", device="Device ID"}
cli = {main="CLI commands (pb today, pb update, etc)"}
utils = {config="TOML config", formatters="Data formatting", updater="Auto-update"}

[structure.service]
windows = ["setup.bat", "install-service.ps1", "run-service.bat (launcher)"]
macos = ["setup.sh", "com.packetbuddy.plist (LaunchAgent)"]
linux = ["setup.sh", "packetbuddy.service.template (systemd)"]

[structure.dashboard]
files = ["index.html", "app.js", "style.css"]
tech = "Vanilla JS + Chart.js, no build process"

[data_flow]
input = "psutil.net_io_counters() → bytes_sent/received"
processing = "Monitor calculates delta → validates → filters anomalies"
storage = "Batch write to SQLite every 30s"
sync = "Upload to NeonDB every 60s (optional)"
output = "FastAPI serves data → Dashboard displays"

[architecture.monitor]
file = "src/core/monitor.py"
method = "Async polling loop"
interval = "1 second (configurable)"
features = ["Counter reset detection", "Anomaly filtering (>1GB/s)", "Auto interface detection"]

[architecture.storage]
file = "src/core/storage.py"
db = "SQLite (~/.packetbuddy/packetbuddy.db)"
schema = {network_usage="id, timestamp, bytes_sent, bytes_received, device_id, synced", device_info="device_id, hostname, platform, created_at"}
optimization = "Batch writes, indexed queries"

[architecture.api]
file = "src/api/server.py"
host = "127.0.0.1"
port = 7373
endpoints = ["/api/health", "/api/live", "/api/today", "/api/month", "/api/summary", "/api/export", "/dashboard/"]

[architecture.auto_update]
trigger = "10s after service start"
process = "git fetch → git pull → pip install -r requirements.txt → restart service"
config = "~/.packetbuddy/config.toml [auto_update] section"
defaults = {enabled=true, check_on_startup=true, auto_apply=true, auto_restart=true}

[windows_service]
mechanism = "Task Scheduler"
launcher = "run-service.bat (sets PYTHONPATH, runs pythonw.exe)"
setup = "service/windows/setup.bat (requires Admin)"
recent_fix = "v1.0.1 - Fixed PYTHONPATH issue, v1.1.2 - Enhanced error handling"

[common_issues]
service_not_starting = {symptoms="ERR_CONNECTION_REFUSED", causes=["Port 7373 in use", "Missing dependencies", "Venv issues", "Firewall"], solution="Run manually: python -m src.api.server, check logs"}
task_scheduler_fail = {symptoms="Works from cmd, fails from scheduler", cause="Missing PYTHONPATH", solution="Re-run setup.bat, uses run-service.bat launcher"}
auto_update_crash = {cause="Missing [auto_update] in config", fix="v1.1.1 added defaults"}

[troubleshooting]
logs = {windows="%USERPROFILE%\\.packetbuddy\\stderr.log", unix="~/.packetbuddy/stderr.log"}
manual_run = "cd packet-buddy && venv/Scripts/activate && python -m src.api.server"
check_service = "curl http://127.0.0.1:7373/api/health"
docs = ["docs/WINDOWS_SERVICE_NOT_STARTING.md", "docs/WINDOWS_TASK_SCHEDULER_FIX.md"]

[config]
location = "~/.packetbuddy/config.toml"
sections = ["api", "monitoring", "sync", "database", "auto_update"]
defaults_in = "src/utils/config.py"

[cli_commands]
usage = "pb today | pb summary | pb month | pb export"
service = "pb service start|stop|restart"
update = "pb update [--check-only] [--force]"

[performance]
cpu = "0.2-0.5%"
ram = "28-40 MB"
disk_io = "~2 KB/s (optimized from ~5 KB/s)"
api_response = "<50ms"
batch_writes = "2,880 writes/day (optimized from 17,280)"

[recent_changes]
v1_3_0 = "Windows setup UX overhaul - stress-free, beautiful UI"
v1_2_1 = "Resource optimization: batch_write 5s→30s, 83% less disk I/O"
v1_2_0 = "TOON format migration, 60% token savings"
v1_1_2 = "Enhanced Windows setup error handling"
v1_1_1 = "Auto-update config defaults"
v1_1_0 = "Automatic updates enabled"
v1_0_1 = "Windows Task Scheduler fix"

[dev_workflow]
run_local = "source venv/bin/activate && python -m src.api.server"
test_api = "curl http://127.0.0.1:7373/api/health"
view_db = "sqlite3 ~/.packetbuddy/packetbuddy.db"
add_endpoint = "Edit src/api/routes.py → Add storage method → Test"

[key_files]
critical = ["src/api/server.py", "src/core/monitor.py", "src/core/storage.py", "run-service.bat (Windows)"]
config = ["config.example.toml", "src/utils/config.py"]
setup = ["service/windows/setup.bat", "service/macos/setup.sh", "service/linux/setup.sh"]
docs = ["README.md", "docs/WINDOWS_SERVICE_NOT_STARTING.md", ".agent/quick-reference.toon"]

[security]
api_binding = "127.0.0.1 only (no external access)"
data_collected = ["bytes_sent", "bytes_received", "timestamp", "device_id"]
data_not_collected = ["URLs", "IPs", "DNS", "app names", "personal info"]
neondb = "TLS encryption (sslmode=require)"

[quick_start]
windows = "git clone → service\\windows\\setup.bat (as Admin) → http://127.0.0.1:7373/dashboard"
macos = "git clone → ./service/macos/setup.sh → open http://127.0.0.1:7373/dashboard"
linux = "git clone → bash service/linux/setup.sh → xdg-open http://127.0.0.1:7373/dashboard"

[for_llms]
read_first = [".agent/quick-reference.toon", ".agent/README.md"]
for_setup_help = "README.md"
for_troubleshooting = [".agent/quick-reference.toon", "docs/WINDOWS_SERVICE_NOT_STARTING.md"]
for_architecture = ".agent/architecture.toon"
for_development = ".agent/codebase.toon"
